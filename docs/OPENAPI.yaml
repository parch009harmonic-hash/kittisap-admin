openapi: 3.1.0
info:
  title: Kittisap Public + Customer API
  version: 1.0.0
  description: |
    API contract for customer-facing storefront and customer account flows.
    Admin APIs are excluded here.
servers:
  - url: https://kittisap.vercel.app
    description: Production
  - url: http://localhost:3000
    description: Local

tags:
  - name: PublicProducts
  - name: PublicPricing
  - name: PublicCoupons
  - name: PublicOrders
  - name: CustomerProfile
  - name: CustomerOrders
  - name: Auth

paths:
  /api/public/products:
    get:
      tags: [PublicProducts]
      summary: List active products
      parameters:
        - in: query
          name: q
          schema: { type: string }
        - in: query
          name: category
          schema: { type: string }
        - in: query
          name: sort
          schema:
            type: string
            enum: [newest, price_asc, price_desc, stock_desc]
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        "200":
          description: Product list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListProductsResponse"

  /api/public/products/{slug}:
    get:
      tags: [PublicProducts]
      summary: Get product detail by slug
      parameters:
        - in: path
          name: slug
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Product detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductDetailResponse"
        "404":
          description: Product not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/public/pricing:
    get:
      tags: [PublicPricing]
      summary: Get pricing table data
      parameters:
        - in: query
          name: groupBy
          schema:
            type: string
            enum: [category, range]
            default: category
      responses:
        "200":
          description: Pricing table
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PricingResponse"

  /api/public/coupons/validate:
    post:
      tags: [PublicCoupons]
      summary: Validate coupon by code
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code, subtotal]
              properties:
                code:
                  type: string
                subtotal:
                  type: number
                  minimum: 0
      responses:
        "200":
          description: Coupon validation result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CouponValidateResponse"
        "400":
          description: Invalid request or invalid coupon
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/public/orders/create:
    post:
      tags: [PublicOrders]
      summary: Create order from selected cart items
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateOrderRequest"
      responses:
        "201":
          description: Order created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateOrderResponse"
        "400":
          description: Validation failure
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Stock/coupon conflict
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/public/orders/{order_no}/slip:
    post:
      tags: [PublicOrders]
      summary: Upload payment slip
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: order_no
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "200":
          description: Slip uploaded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadSlipResponse"
        "400":
          description: Invalid file
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/customer/profile:
    get:
      tags: [CustomerProfile]
      summary: Get current customer profile
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProfileResponse"
    put:
      tags: [CustomerProfile]
      summary: Update current customer profile
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                fullName: { type: string }
                phone: { type: string }
      responses:
        "200":
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProfileResponse"

  /api/customer/orders:
    get:
      tags: [CustomerOrders]
      summary: List my orders
      security:
        - cookieAuth: []
      responses:
        "200":
          description: My orders
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MyOrdersResponse"

  /api/auth/register:
    post:
      tags: [Auth]
      summary: Register customer account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string, minLength: 8 }
                fullName: { type: string }
                phone: { type: string }
      responses:
        "200":
          description: Register success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BasicOkResponse"

  /api/auth/login:
    post:
      tags: [Auth]
      summary: Login customer account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string }
      responses:
        "200":
          description: Login success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BasicOkResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: sb-access-token

  schemas:
    BasicOkResponse:
      type: object
      properties:
        ok: { type: boolean, const: true }

    ErrorResponse:
      type: object
      required: [ok, code, error]
      properties:
        ok:
          type: boolean
          const: false
        code:
          type: string
          examples:
            - AUTH_REQUIRED
            - INVALID_REQUEST
            - OUT_OF_STOCK
            - COUPON_INVALID
        error:
          type: string

    Product:
      type: object
      properties:
        id: { type: string, format: uuid }
        slug: { type: string }
        sku: { type: string }
        title_th: { type: string }
        title_en: { type: string, nullable: true }
        price: { type: number }
        stock: { type: integer }
        status: { type: string }
        category_name: { type: string, nullable: true }
        cover_url: { type: string, nullable: true }

    ProductImage:
      type: object
      properties:
        id: { type: string, format: uuid }
        url: { type: string }
        sort: { type: integer }
        is_primary: { type: boolean }

    ListProductsResponse:
      type: object
      properties:
        ok: { type: boolean, const: true }
        data:
          type: object
          properties:
            items:
              type: array
              items:
                $ref: "#/components/schemas/Product"
            page: { type: integer }
            pageSize: { type: integer }
            totalPages: { type: integer }
            total: { type: integer }

    ProductDetailResponse:
      type: object
      properties:
        ok: { type: boolean, const: true }
        data:
          allOf:
            - $ref: "#/components/schemas/Product"
            - type: object
              properties:
                images:
                  type: array
                  items:
                    $ref: "#/components/schemas/ProductImage"

    PricingGroup:
      type: object
      properties:
        key: { type: string }
        label: { type: string }
        items:
          type: array
          items:
            $ref: "#/components/schemas/Product"

    PricingResponse:
      type: object
      properties:
        ok: { type: boolean, const: true }
        data:
          type: object
          properties:
            groupBy: { type: string }
            groups:
              type: array
              items:
                $ref: "#/components/schemas/PricingGroup"

    CouponValidateResponse:
      type: object
      properties:
        ok: { type: boolean, const: true }
        data:
          type: object
          properties:
            code: { type: string }
            discount_type: { type: string, enum: [percent, fixed] }
            discount_amount: { type: number }
            final_amount: { type: number }

    CreateOrderRequest:
      type: object
      required: [items, customer]
      properties:
        items:
          type: array
          minItems: 1
          items:
            type: object
            required: [product_id, qty]
            properties:
              product_id: { type: string, format: uuid }
              qty: { type: integer, minimum: 1 }
        customer:
          type: object
          required: [full_name, phone]
          properties:
            full_name: { type: string }
            phone: { type: string }
            note: { type: string }
        coupon:
          type: string

    CreateOrderResponse:
      type: object
      properties:
        ok: { type: boolean, const: true }
        data:
          type: object
          properties:
            order_no: { type: string }
            promptpay_url: { type: string }
            final_amount: { type: number }

    UploadSlipResponse:
      type: object
      properties:
        ok: { type: boolean, const: true }
        data:
          type: object
          properties:
            order_no: { type: string }
            review_status: { type: string, enum: [pending] }

    ProfileResponse:
      type: object
      properties:
        ok: { type: boolean }
        data:
          type: object
          nullable: true
          properties:
            id: { type: string, format: uuid }
            full_name: { type: string, nullable: true }
            phone: { type: string, nullable: true }
            line_id: { type: string, nullable: true }
            is_active: { type: boolean }

    MyOrder:
      type: object
      properties:
        order_no: { type: string }
        status: { type: string }
        final_amount: { type: number }
        created_at: { type: string, format: date-time }

    MyOrdersResponse:
      type: object
      properties:
        ok: { type: boolean, const: true }
        data:
          type: object
          properties:
            items:
              type: array
              items:
                $ref: "#/components/schemas/MyOrder"
